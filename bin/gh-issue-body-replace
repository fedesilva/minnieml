#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 2 || $# -gt 3 ]]; then
  echo "Usage: $(basename "$0") <issue-number> <perl-expression> [repo]" >&2
  echo "Example: $(basename "$0") 220 \"s/- \\[ \\] \\*\\*Task\\*\\*/- [x] **Task** [COMPLETE]/g\" fedesilva/minnieml" >&2
  exit 1
fi

issue="$1"
perl_expr="$2"
repo="${3:-fedesilva/minnieml}"

tmp="$(mktemp)"
trap 'rm -f "$tmp"' EXIT

gh issue view "$issue" --repo "$repo" --json body --jq .body > "$tmp"

perl -0pi -e "$perl_expr" "$tmp"

gh issue edit "$issue" --repo "$repo" --body-file "$tmp" >/dev/null
echo "Updated issue #$issue in $repo"
